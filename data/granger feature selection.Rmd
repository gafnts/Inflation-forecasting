# Feature selection

```{r}
pacman::p_load(tidyverse, magrittr, broom, lmtest, here)
```

```{r}
secmca <- read_csv(here("data", "raw", "secmca.csv"))
```

### Vectorized Granger causality test

```{r}
granger_test <- function(data, x, y, lag) {
  x <- 
    data %>% 
    select(!!enquo(x)) %>% 
    pull() %>% 
    as.ts()
  
  y <- 
    data %>% 
    select(!!enquo(y)) %>% 
    pull() %>% 
    as.ts()
  
  grangertest(x, y, order = lag) %>% 
    tidy() %>% 
    select(3, 4) %>% 
    na.omit()
}

granger <- function(data, x, y, p_value) {
  list <- list()
  df <- data.frame()

  for (i in 1:24) {
    list <- granger_test(data, !!enquo(x), !!enquo(y), lag = i)
    df <- rbind(df, list) 
  } 
  
  df %<>% 
    rowid_to_column() %>% 
    filter(p.value < !!enquo(p_value)) %>% 
    arrange(p.value) %>% 
    slice(1:3)
    
  return(df)
}
```

```{r}
names <- 
  secmca %>% 
  select(-c(fecha, ipc_variacion_interanual)) %>%
  names() %>% 
  sort()
```

```{r}
lags <- list()

for (i in names) {
  lags[[i]] <- granger(secmca, ipc_variacion_interanual, all_of(i), 0.05)
}

lags
```
