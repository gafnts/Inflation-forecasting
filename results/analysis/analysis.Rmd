# Analysis

```{r}
pacman::p_load(tidyverse, kableExtra, magrittr, here, yardstick)
main <- read_csv(here("data", "main.csv")) %>% select(fecha, ipc) %>% rowid_to_column(".row")
```

## 24 steps ahead forecasts plot

### Time series

```{r}
setwd(here("results"))
snaive <- read_csv("snaive_24_forecast.csv")
ar <- read_csv("ar_24_forecast.csv")
sarima <- read_csv("sarima_24_forecast.csv")
hw <- read_csv("hw_24_forecast.csv") %>% mutate(key = "holt-winters")
var <- read_csv("var_24_forecast.csv") 
setwd(here())
```

```{r}
ts_bind <- 
  list(snaive, ar, sarima, hw, var) %>% 
  reduce(bind_rows) %>% 
  pivot_wider(names_from = key, values_from = .pred)

ts_forecasts <- 
  main %>% 
  left_join(ts_bind %>% mutate(.row = 181:204)) %>% 
  select(-.row) %>% 
  filter(between(fecha, as.Date("2019-01-01"), as.Date("2021-12-01"))) %>% 
  pivot_longer(!fecha, names_to = "model", values_to = "value") %>% 
  arrange(model, fecha)
```

### Machine learning

```{r}
setwd(here("results"))
# knn <- read_csv("knn_24_forecast.csv") %>% mutate(key = "knn")
lstm <- read_csv("lstm_24_forecast.csv") %>% mutate(key = "lstm")
mlp <- read_csv("mlp_24_forecast.csv") %>% mutate(key = "mlp")
rf <- read_csv("rf_24_forecast.csv") %>% mutate(key = "rf")
svm <- read_csv("svm_24_forecast.csv") %>% mutate(key = "svm")
xgb <- read_csv("xgb_24_forecast.csv") %>% mutate(key = "xgb")
setwd(here())
```

```{r}
ml_bind <- 
  list(mlp, rf, svm, xgb) %>% 
  reduce(bind_rows) %>% 
  select(-ipc) %>% 
  pivot_wider(names_from = key, values_from = .pred) %>% 
  bind_cols(lstm %>% select("lstm" = .pred))

ml_forecasts <- 
  main %>% 
  left_join(ml_bind) %>% 
  select(-.row) %>% 
  filter(between(fecha, as.Date("2019-01-01"), as.Date("2021-12-01"))) %>% 
  pivot_longer(!fecha, names_to = "model", values_to = "value") %>% 
  arrange(model, fecha)
```

```{r}
ts_forecasts %>% write_csv(here("results", "analysis", "ts_24_forecasts.csv"))
ml_forecasts %>% write_csv(here("results", "analysis", "ml_24_forecasts.csv"))
```

## Weighted mean forecasts

### Time series

```{r}
ipc <- 
  ts_forecasts %>% 
  drop_na() %>% 
  filter(model == "ipc" & between(fecha, as.Date("2020-01-01"), as.Date("2021-12-01"))) %>% 
  rename("ipc" = model, "truth" = value)

ts_models <- 
  ts_forecasts %>% 
  drop_na() %>% 
  filter(model != "ipc") %>% 
  rename("estimate" = value)

ts_ensamble <- 
  ts_models %>% 
  left_join(ipc) %>% 
  group_by(model, fecha) %>% 
  mutate(mae = mae_vec(truth = truth, estimate = estimate)) %>% 
  ungroup() %>% 
  select(fecha, model, estimate, mae) %>% 
  group_by(fecha) %>% 
  mutate(weigth = 1 - (mae / sum(mae))) %>% 
  summarise(`Modelos de series de tiempo` = weighted.mean(estimate, weigth))

ts_mean_forecasts <- 
  main %>% 
  left_join(ts_ensamble) %>% 
  select(-.row) %>% 
  filter(between(fecha, as.Date("2018-01-01"), as.Date("2021-12-01"))) %>% 
  pivot_longer(!fecha, names_to = "model", values_to = "value") %>% 
  arrange(model, fecha)
```

### Machine learning

```{r}
ipc <- 
  ml_forecasts %>% 
  drop_na() %>% 
  filter(model == "ipc" & between(fecha, as.Date("2020-01-01"), as.Date("2021-12-01"))) %>% 
  rename("ipc" = model, "truth" = value)

ml_models <- 
  ml_forecasts %>% 
  drop_na() %>% 
  filter(model != "ipc") %>% 
  rename("estimate" = value)

ml_ensamble <- 
  ml_models %>% 
  left_join(ipc) %>% 
  group_by(model, fecha) %>% 
  mutate(mae = mae_vec(truth = truth, estimate = estimate)) %>% 
  ungroup() %>% 
  select(fecha, model, estimate, mae) %>% 
  group_by(fecha) %>% 
  mutate(weigth = 1 - (mae / sum(mae))) %>% 
  summarise(`Modelos de aprendizaje estadístico` = weighted.mean(estimate, weigth))

ml_mean_forecasts <- 
  main %>% 
  left_join(ml_ensamble) %>% 
  select(-.row) %>% 
  filter(between(fecha, as.Date("2018-01-01"), as.Date("2021-12-01"))) %>% 
  pivot_longer(!fecha, names_to = "model", values_to = "value") %>% 
  arrange(model, fecha)
```

```{r}
ts_mean_forecasts %>% write_csv(here("results", "analysis", "ts_mean_forecasts.csv"))
ml_mean_forecasts %>% write_csv(here("results", "analysis", "ml_mean_forecasts.csv"))
```

```{r}
  ml_models %>% 
  left_join(ipc) %>% 
  group_by(model, fecha) %>% 
  mutate(mae = mae_vec(truth = truth, estimate = estimate)) %>% 
  ungroup() %>% 
  select(fecha, model, estimate, mae) %>% 
  group_by(fecha) %>% 
  mutate(weigth = 1 - (mae / sum(mae))) %>% 
  summarise(`Modelos de aprendizaje estadístico` = weighted.mean(estimate, weigth))
```
