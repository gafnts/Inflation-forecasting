# Naïve, AR and ARMA

```{r}
pacman::p_load(tidyverse, tidymodels, here, forecast, tseries, tictoc)
data <- read_csv(here("data", "main.csv")) %>% rename("date" = fecha)
```

```{r}
ipc <- ts(data %>% select(ipc), start = c(2005, 1), frequency = 12)

  train <- ts(data %>% 
              filter(between(date, as.Date("2005-01-01"), as.Date("2019-12-01"))) %>% 
              select(ipc), start = c(2005, 1), frequency = 12)
  
  test <- data %>% select(ipc) %>% tail(24) 
```

### Exploratory data analysis

```{r}
ipc %>% ggtsdisplay()
ipc %>% decompose() %>% autoplot()
ipc %>% ggseasonplot()
ipc %>% adf.test()
```

```{r}
snaïve <- function(h) {
  tic("snaive")
  
  forecast <- 
    snaive(train, h = h) %>% 
    as_tibble() %>% 
    rename(".pred" = `Point Forecast`) %>% 
    mutate(key = "snaïve") %>% 
    rowid_to_column(".row") %>% 
    select(.pred, .row, key)
  
   toc(log = TRUE)
   time <- tic.log(format = TRUE)
   tic.clearlog()
  
  mae <-
    forecast %>% 
    select(.pred) %>% 
    bind_cols(test %>% select(ipc)) %>% 
    rename("truth" = ipc, "estimate" = .pred) %>% 
    mae(truth = truth, estimate = estimate)
  
  mase <-
    forecast %>% 
    select(.pred) %>% 
    bind_cols(test %>% select(ipc)) %>% 
    rename("truth" = ipc, "estimate" = .pred) %>% 
    mase(truth = truth, estimate = estimate)
  
  metrics <- bind_rows(mae, mase)
  
  results <- list(forecast, metrics, time)
  return(results)
}
```

### Seasonal naïve

```{r}
snaive <- 
  snaive(train, h = 24) %>% 
  as_tibble() %>% 
  rename(".pred" = `Point Forecast`) %>% 
  mutate(key = "snaïve") %>% 
  rowid_to_column(".row") %>% 
  select(.pred, .row, key)
```

```{r}
mae <-
  snaive %>% 
  select(.pred) %>% 
      bind_cols(test %>% select(ipc)) %>% 
      rename("truth" = ipc, "estimate" = .pred) %>% 
      mae(truth = truth, estimate = estimate)

mase <-
  snaive %>% 
  select(.pred) %>% 
      bind_cols(test %>% select(ipc)) %>% 
      rename("truth" = ipc, "estimate" = .pred) %>% 
      mase(truth = truth, estimate = estimate)
```

```{r}
snaïve <- function(h) {
  tic("snaive")
  
  forecast <- 
    snaive(train, h = h) %>% 
    as_tibble() %>% 
    rename(".pred" = `Point Forecast`) %>% 
    mutate(key = "snaïve") %>% 
    rowid_to_column(".row") %>% 
    select(.pred, .row, key)
  
   toc(log = TRUE)
   time <- tic.log(format = TRUE)
   tic.clearlog()
  
  mae <-
    forecast %>% 
    select(.pred) %>% 
    bind_cols(test %>% select(ipc)) %>% 
    rename("truth" = ipc, "estimate" = .pred) %>% 
    mae(truth = truth, estimate = estimate)
  
  mase <-
    forecast %>% 
    select(.pred) %>% 
    bind_cols(test %>% select(ipc)) %>% 
    rename("truth" = ipc, "estimate" = .pred) %>% 
    mase(truth = truth, estimate = estimate)
  
  metrics <- bind_rows(mae, mase)
  
  results <- list(forecast, metrics, time)
  return(results)
}
```

```{r}
snaive_12 <- snaïve(h = 12)

snaive_12[[1]] %>% write_csv(here("results", "snaive_12_forecast.csv"))
snaive_12[[2]] %>% write_csv(here("results", "snaive_12_metrics.csv"))
snaive_12[[3]][[1]] %>% as_tibble() %>% write_csv(here("results", "snaive_12_time.csv"))
```

```{r}
snaive_24 <- snaïve(h = 24)

snaive_24[[1]] %>% write_csv(here("results", "snaive_24_forecast.csv"))
snaive_24[[2]] %>% write_csv(here("results", "snaive_24_metrics.csv"))
snaive_24[[3]][[1]] %>% as_tibble() %>% write_csv(here("results", "snaive_24_time.csv"))
```

### Safety checks

```{r}
snaive_24[[1]] %>% 
  bind_cols(test) %>% 
  select(-key) %>% 
  pivot_longer(-.row) %>% 
  ggplot(aes(.row, value, color = name)) +
  geom_line()
```

#### AR(1)

```{r}
arima(ipc, order = c(5,0,0)) %>% forecast(h = 24)
```
